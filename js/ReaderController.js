var Reader={continuationToken:"",startindex:0,endindex:0,refetchSent:0,syncWithGoogle:function(){showLoaderMessage("Loading...");GoogleReader.loginViaOauth(function(a){"OK"==a&&(addContextMenu(),pokki.rpc("BackgroundWorker.updateFromGoogle()"),Reader.syncSubscriptions(),window.localStorage.setItem("isSyncOn","true"))})},syncSubscriptions:function(){!0==GoogleReader.hasAuth()&&($("loadercontainer").find(".button green").css("display","none"),$("#syncProgressBar").css("display","block"),showLoaderMessage("Fetching Google Reader Subscriptions..."),
GoogleReader.getSubscriptionList(function(a){showLoaderMessage("Fetching Local Subscriptions...");var c=DbManager.getSubscriptionIds(function(){var e=c;if(null==c)c=[];else{for(var b in c)b=b.split("?")[0];c.sort()}a=a.subscriptions;if(0!=a.length){for(b=0;b<a.length;b++)a[b].id=a[b].id.substr(5);a.sort(function(a,b){return a.id<b.id?-1:1})}var d=b=0;showLoaderMessage("Syncing...");for(var f=100/(c.length+a.length);d<c.length&&b<a.length;){for(;d<c.length&&b<a.length&&a[b].id<c[d];)DbManager.insertSubscription(a[b].id,
a[b].htmlUrl,a[b].title,null),b++,showProgress(f,!0);for(;d<c.length&&b<a.length&&c[d]<a[b].id;)GoogleReader.subscribe(c[d],"title"),d++,showProgress(f,!0);for(;d<c.length&&b<a.length&&c[d]==a[b].id;)e[d]!=c[d]&&(DbManager.removeSubscription(e[d]),DbManager.insertSubscription(a[b].id,a[b].htmlUrl,a[b].title,null)),b++,d++,showProgress(2*f,!0)}for(;b<a.length;)DbManager.insertSubscription(a[b].id,a[b].htmlUrl,a[b].title,null),b++,showProgress(f,!0);for(;d<c.length;)GoogleReader.subscribe(c[d],"title"),
d++,showProgress(f,!0);FeedViewer.renderAddFeeds();FeedViewer.renderMyFeeds();continueLocal()})}))},subscribe:function(a){var c=null;try{c=a.alternate[0].href}catch(e){}DbManager.insertSubscription(a.id,c,a.title,null);!0==GoogleReader.hasAuth()&&GoogleReader.subscribe(a.id,a.title,!1)},unsubscribe:function(a,c){DbManager.removeSubscription(a,c);!0==GoogleReader.hasAuth()&&GoogleReader.unsubscribe(a,function(){})},editItemTag:function(a,c,e,b){b?b!=e&&DbManager.updateItemTag(a,c,e):DbManager.insertItemTag(a,
c,e);!0==GoogleReader.hasAuth()&&(b?b!=e&&GoogleReader.editItemTag(a,c,e,b):GoogleReader.addItemTag(a,c,e))},markAllAsRead:function(a,c){GoogleReader.markAllAsRead(a,function(){DbManager.updateUnreadCount(a,0);c&&c()})},getFeedContent:function(a,c,e){var b="";window.localStorage.getItem("readMode")==SHOWUNREAD&&(b="read");GoogleReader.getFeedContent(a,20,b,Reader.continuationToken,function(b){c&&c();Reader.continuationToken=b.continuation;var e=Reader.endindex;Reader.endindex+=b.items.length;Reader.refetchSent=
0;modes.switchToMode(2);ReaderViewer.renderGoogleFeed(b,e,Reader.endindex,a)},e)},getNextContent:function(a,c){10>Reader.endindex-c&&(0==Reader.refetchSent&&90>Reader.endindex)&&DbManager.getUnreadCount(a,function(c){if(!GoogleReader.hasAuth()||window.localStorage.getItem("readMode")!=SHOWUNREAD||c>Reader.endindex)Reader.refetchSent=1,$("#headlactions").find("img").show(),Reader.getFeedContent(a,function(){$("#headlactions").find("img").hide()},function(){$("#headlactions").find("img").hide();$("#headlactions").find("h2").fadeIn().delay(2E3).fadeOut("slow");
Reader.refetchSent=0})})},resetState:function(){this.continuationToken="";this.refetchSent=this.endindex=this.startindex=0},logout:function(a){!0==a&&($("#loadingScreen").css("visibility","visible").css("display","block"),DbManager.emptyDatabase(function(){FeedViewer.renderAddFeeds();$("#loadingScreen").css("visibility","hidden").css("display","none")}));FeedViewer.renderMyFeeds();hideLogoutPopup()}};
